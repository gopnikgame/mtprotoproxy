# 📊 Визуализация архитектуры MTProto + Remnawave

## 🔄 Полный поток данных

```
┌──────────────────────────────────────────────────────────────────────┐
│                              КЛИЕНТ                                   │
│                     (Telegram на телефоне/ПК)                        │
└──────────────────────────┬───────────────────────────────────────────┘
                           │
                           │ TLS handshake с SNI: proxy.example.com
                           │
                           ▼
┌──────────────────────────────────────────────────────────────────────┐
│                       ИНТЕРНЕТ (Port 443)                             │
└──────────────────────────┬───────────────────────────────────────────┘
                           │
                           │ HTTPS (Port 443)
                           │
                           ▼
┌──────────────────────────────────────────────────────────────────────┐
│              🐳 DOCKER: remnawave-nginx                               │
│              network_mode: host                                       │
│              Контейнер: Nginx 1.29.1                                  │
│                                                                        │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                     stream.conf                               │   │
│  │             (SNI-based Routing - Layer 4)                     │   │
│  │                                                                │   │
│  │  map $ssl_preread_server_name $backend_name {                │   │
│  │      proxy.example.com    ──► mtproto_backend                │   │
│  │      3.example.com     ──► xray_reality                   │   │
│  │      3-x.example.com   ──► nginx_backend                  │   │
│  │      default              ──► nginx_backend                  │   │
│  │  }                                                             │   │
│  │                                                                │   │
│  │  upstream mtproto_backend {                                   │   │
│  │      server 127.0.0.1:10443;  ◄─── Backend для MTProto       │   │
│  │  }                                                             │   │
│  │                                                                │   │
│  │  upstream xray_reality {                                      │   │
│  │      server 127.0.0.1:9443;   ◄─── Xray Reality              │   │
│  │  }                                                             │   │
│  │                                                                │   │
│  │  upstream nginx_backend {                                     │   │
│  │      server 127.0.0.1:8443;   ◄─── Основной сайт             │   │
│  │  }                                                             │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                           │                                            │
└───────────────────────────┼────────────────────────────────────────────┘
                            │
                            │ proxy_pass + proxy_protocol
                            │ (передает реальный IP клиента)
                            │
                            ▼
                     127.0.0.1:10443
                            │
┌───────────────────────────┼────────────────────────────────────────────┐
│              🐳 DOCKER: remnawave-nginx                               │
│                                                                        │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │         Nginx Server Block (sites-available/)                 │   │
│  │         Файл: proxy.example.com                               │   │
│  │                                                                │   │
│  │  server {                                                      │   │
│  │      listen 10443 ssl proxy_protocol;                         │   │
│  │      server_name proxy.example.com;                           │   │
│  │                                                                │   │
│  │      ssl_certificate     /etc/letsencrypt/.../fullchain.pem;  │   │
│  │      ssl_certificate_key /etc/letsencrypt/.../privkey.pem;    │   │
│  │                                                                │   │
│  │      location / {                                              │   │
│  │          proxy_pass http://127.0.0.1:8888;  ◄── К MTProto     │   │
│  │          proxy_http_version 1.1;                              │   │
│  │          proxy_set_header X-Real-IP $proxy_protocol_addr;     │   │
│  │          ...таймауты и настройки...                           │   │
│  │      }                                                          │   │
│  │  }                                                              │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                           │                                            │
└───────────────────────────┼────────────────────────────────────────────┘
                            │
                            │ HTTP/1.1 (чистый HTTP без SSL)
                            │ proxy_pass
                            │
                            ▼
                     127.0.0.1:8888
                            │
┌───────────────────────────┼────────────────────────────────────────────┐
│              🐳 DOCKER: mtprotoproxy                                  │
│              network_mode: host                                       │
│              Контейнер: Python 3.11-slim                              │
│                                                                        │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │                  MTProto Proxy Server                         │   │
│  │                  (Python - mtprotoproxy.py)                   │   │
│  │                                                                │   │
│  │  - Слушает 127.0.0.1:8888                                     │   │
│  │  - Использует config.py (секреты, настройки)                 │   │
│  │  - TLS mode enabled                                           │   │
│  │  - TLS_DOMAIN = "www.google.com"                              │   │
│  │  - Криптография: pyaes/                                       │   │
│  │                                                                │   │
│  │  Функции:                                                      │   │
│  │  ✅ Аутентификация клиентов                                   │   │
│  │  ✅ Шифрование/дешифрование                                   │   │
│  │  ✅ Обфускация трафика (TLS mode)                             │   │
│  │  ✅ Статистика подключений                                    │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                           │                                            │
└───────────────────────────┼────────────────────────────────────────────┘
                            │
                            │ MTProto протокол
                            │ (зашифрованный)
                            │
                            ▼
┌──────────────────────────────────────────────────────────────────────┐
│                      TELEGRAM SERVERS                                 │
│                   (dc1.telegram.org, etc.)                            │
└──────────────────────────────────────────────────────────────────────┘


┌──────────────────────────────────────────────────────────────────────┐
│            🐳 DOCKER: remnanode (Parallel Service)                    │
│            network_mode: host                                         │
│            Контейнер: remnawave/node:latest                           │
│                                                                        │
│  - API: 127.0.0.1:3066                                                │
│  - Xray Reality: 127.0.0.1:9443                                       │
│  - Обрабатывает трафик для 3.example.com                          │
└──────────────────────────────────────────────────────────────────────┘
```

---

## 🔍 Детализация уровней

### **Уровень 1: Интернет → Nginx (Port 443)**

```
Клиент                          Сервер
  │                               │
  ├─► TCP SYN ────────────────────►│
  │◄─ TCP SYN-ACK ────────────────┤
  ├─► TCP ACK ────────────────────►│
  │                               │
  ├─► TLS ClientHello ───────────►│  ← SNI: proxy.example.com
  │   (с SNI extension)           │
  │                               │
  │                         ┌─────▼─────┐
  │                         │ stream.conf│
  │                         │ читает SNI│
  │                         └─────┬─────┘
  │                               │
  │                         [Роутинг по SNI]
  │                               │
  │   ┌─────────────────────────────────┬──────────────────┐
  │   ▼                                 ▼                  ▼
  │ mtproto_backend             xray_reality        nginx_backend
  │ (10443)                        (9443)              (8443)
```

### **Уровень 2: SNI Routing → Upstream**

```
stream.conf decision tree:

┌─ SNI = "proxy.example.com" ──► upstream mtproto_backend
│                                  └─► 127.0.0.1:10443
│
├─ SNI = "3.example.com" ────► upstream xray_reality
│                                  └─► 127.0.0.1:9443
│
├─ SNI = "3-x.example.com" ──► upstream nginx_backend
│                                  └─► 127.0.0.1:8443
│
└─ SNI = (other/default) ────────► upstream nginx_backend
                                   └─► 127.0.0.1:8443
```

### **Уровень 3: Nginx Server Block (10443) → MTProto (8888)**

```
┌─────────────────────────────────────────────────────────┐
│              Nginx Server Block                          │
│              Listen: 127.0.0.1:10443                     │
├─────────────────────────────────────────────────────────┤
│                                                           │
│  1. SSL/TLS терминация                                   │
│     - Использует сертификат Let's Encrypt                │
│     - Дешифрует HTTPS трафик                             │
│     - Получает чистый HTTP                               │
│                                                           │
│  2. Обработка Proxy Protocol                             │
│     - Извлекает реальный IP клиента                      │
│     - Сохраняет в $proxy_protocol_addr                   │
│                                                           │
│  3. Установка заголовков                                 │
│     - X-Real-IP: <client_ip>                             │
│     - X-Forwarded-For: <client_ip>                       │
│     - X-Forwarded-Proto: https                           │
│     - Host: proxy.example.com                            │
│                                                           │
│  4. Настройка таймаутов                                  │
│     - proxy_connect_timeout: 300s                        │
│     - proxy_send_timeout: 300s                           │
│     - proxy_read_timeout: 300s                           │
│                                                           │
│  5. Proxy Pass                                           │
│     └─► http://127.0.0.1:8888                           │
│                                                           │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
                   127.0.0.1:8888
                          │
┌─────────────────────────┼───────────────────────────────┐
│                         ▼                                │
│              MTProto Proxy Server                        │
│                                                           │
│  Получает:                                               │
│  - HTTP/1.1 запрос                                       │
│  - Заголовки с реальным IP                               │
│  - Чистый (не зашифрованный) трафик                      │
│                                                           │
│  Обрабатывает:                                           │
│  1. Проверяет секрет клиента                             │
│  2. Дешифрует MTProto сообщения                          │
│  3. Применяет обфускацию (TLS mode)                      │
│  4. Проксирует на Telegram серверы                       │
│                                                           │
└───────────────────────────────────────────────────────────┘
```

### **Уровень 4: MTProto → Telegram**

```
┌────────────────────────────────────────────────────────┐
│           MTProto Proxy Process                         │
├────────────────────────────────────────────────────────┤
│                                                          │
│  1. Клиент подключается с секретом                      │
│     Secret: ee[domain_hex][secret]                      │
│                                                          │
│  2. MTProto аутентификация                              │
│     - Проверка секрета                                  │
│     - Установка шифрования                              │
│                                                          │
│  3. Обработка MTProto сообщений                         │
│     Клиент ──► [Шифрование] ──► Proxy                   │
│     Proxy  ──► [Дешифрование + Анализ]                  │
│     Proxy  ──► [Re-encryption] ──► Telegram             │
│                                                          │
│  4. TLS обфускация (опционально)                        │
│     - Маскирует трафик под обычный HTTPS                │
│     - Плохие клиенты → TLS_DOMAIN (www.google.com)      │
│                                                          │
│  5. Статистика                                          │
│     - Количество подключений                            │
│     - Объем переданных данных                           │
│     - Активные сессии                                   │
│                                                          │
└────────────────────────────────────────────────────────┘
                          │
                          ▼
        ┌─────────────────────────────────┐
        │    Telegram Datacenters         │
        │    - dc1.telegram.org           │
        │    - dc2.telegram.org           │
        │    - dc3.telegram.org           │
        │    - etc.                       │
        └─────────────────────────────────┘
```

---

## 🔐 Безопасность и изоляция

```
┌────────────────────────────────────────────────────────────┐
│                   DOCKER HOST (Server)                      │
│                   network_mode: host                        │
│                                                              │
│  ┌─────────────────────────────────────────────────┐       │
│  │  Process Isolation (Docker Containers)          │       │
│  │                                                  │       │
│  │  ┌──────────────┐  ┌──────────────┐  ┌────────┐│       │
│  │  │ remnawave-   │  │ mtprotoproxy │  │ remna  ││       │
│  │  │    nginx     │  │  (isolated)  │  │ node   ││       │
│  │  │              │  │              │  │        ││       │
│  │  │ User: nginx  │  │ User: root   │  │ User:  ││       │
│  │  │ PID: 1234    │  │ PID: 5678    │  │ root   ││       │
│  │  │              │  │              │  │ PID:   ││       │
│  │  │ Volumes:     │  │ Volumes:     │  │ 9012   ││       │
│  │  │ - /etc/nginx │  │ - config.py  │  │        ││       │
│  │  │ - /etc/      │  │   (ro)       │  │ Volumes││       │
│  │  │   letsencrypt│  │ - mtproto    │  │ - /dev ││       │
│  │  │   (ro)       │  │   proxy.py   │  │  /shm  ││       │
│  │  └──────────────┘  │   (ro)       │  └────────┘│       │
│  │                    │ - pyaes/     │             │       │
│  │                    │   (ro)       │             │       │
│  │                    └──────────────┘             │       │
│  └─────────────────────────────────────────────────┘       │
│                                                              │
│  Network: 127.0.0.1 (localhost only)                        │
│  ┌────────────────────────────────────────────────┐        │
│  │  127.0.0.1:443   ← remnawave-nginx (external)  │        │
│  │  127.0.0.1:8443  ← nginx backend (internal)    │        │
│  │  127.0.0.1:10443 ← mtproto backend (internal)  │        │
│  │  127.0.0.1:8888  ← mtprotoproxy (internal)     │        │
│  │  127.0.0.1:9443  ← xray reality (internal)     │        │
│  │  127.0.0.1:3066  ← remnanode API (internal)    │        │
│  └────────────────────────────────────────────────┘        │
│                                                              │
│  Firewall (ufw):                                            │
│  - Allow: 80, 443 (from anywhere)                           │
│  - Deny: 8888, 10443, 9443, 3066 (only localhost)          │
│                                                              │
└────────────────────────────────────────────────────────────┘
```

---

## 📊 Сравнение с альтернативными архитектурами

### **Вариант A: Текущая архитектура (✅ ИСПОЛЬЗУЕТСЯ)**

```
Internet:443 → Nginx (stream + SNI) → Server Block (10443) → MTProto (8888)
               ↑                       ↑                      ↑
               │                       │                      │
           SSL term                Proxy Pass            Final Handler
         + SNI routing             + Headers            + MTProto logic
```

**Плюсы:**
- ✅ Полный контроль SSL/TLS
- ✅ Централизованное логирование
- ✅ Гибкая настройка таймаутов
- ✅ Proxy Protocol для реальных IP
- ✅ Единая точка входа (443)

**Минусы:**
- ⚠️ Два уровня проксирования (minimal overhead)

---

### **Вариант B: Прямое подключение (❌ НЕ ИСПОЛЬЗУЕТСЯ)**

```
Internet:443 → Nginx (stream + SNI) → MTProto (8888)
               ↑                       ↑
               │                       │
           SSL term                MTProto logic
         + SNI routing
```

**Плюсы:**
- ✅ Один уровень проксирования

**Минусы:**
- ❌ Нет SSL терминации в Nginx
- ❌ MTProto должен обрабатывать SSL
- ❌ Сложнее настраивать заголовки
- ❌ Нет централизованного логирования Nginx

---

### **Вариант C: Bridge Network (❌ НЕ СОВМЕСТИМО)**

```
Internet:443 → Nginx → Docker Bridge Network → MTProto
                       ↑
                       │
                  container networking
```

**Плюсы:**
- ✅ Лучшая изоляция

**Минусы:**
- ❌ Remnawave уже использует host network
- ❌ Потребуется переделывать всю архитектуру
- ❌ Больше сложности
- ❌ Overhead от Docker networking

---

## 🎯 Итоги

### **Текущая архитектура оптимальна потому что:**

1. ✅ **Совместимость:** Работает с существующей Remnawave
2. ✅ **Модульность:** Каждый сервис в своем контейнере
3. ✅ **Безопасность:** Process isolation + SSL/TLS
4. ✅ **Производительность:** Host network без overhead
5. ✅ **Управляемость:** Простое обслуживание и отладка
6. ✅ **Масштабируемость:** Легко добавлять новые домены

### **Ключевые технологии:**

- 🐳 **Docker:** Изоляция процессов
- 🌐 **Nginx Stream:** SNI-based L4 роутинг
- 🔒 **SSL/TLS:** Шифрование и сертификаты
- 🔀 **Proxy Protocol:** Передача реальных IP
- 📡 **MTProto:** Telegram протокол
- 🎭 **TLS Obfuscation:** Маскировка трафика

---

💡 **Эта архитектура является production-ready и масштабируемой!**
